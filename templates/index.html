<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preditor — Dashboard Avançado</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            background: #f2f4f8;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        }
        header {
            background: #1f2937;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 22px;
            font-weight: 600;
        }
        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: #2563eb;
            color: white;
            font-size: 16px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .green { color: #10b981; font-weight: 600; }
        .red { color: #ef4444; font-weight: 600; }
        #status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #6b7280;
        }
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>

<body>

<header>DASHBOARD — Preditor de Criptomoedas</header>

<div class="container">

    <button id="predictBtn" class="btn">Analisar Top 20</button>

    <div id="status">Clique para iniciar.</div>

    <div id="results"></div>

</div>

<script>
const coins = [
    "BTC/USDT","ETH/USDT","XRP/USDT","LTC/USDT","BCH/USDT",
    "ADA/USDT","DOGE/USDT","DOT/USDT","UNI/USDT","LINK/USDT",
    "SOL/USDT","MATIC/USDT","ETC/USDT","FIL/USDT","AAVE/USDT",
    "MKR/USDT","COMP/USDT","SNX/USDT","YFI/USDT","AVAX/USDT"
];

const btn = document.getElementById("predictBtn");
const status = document.getElementById("status");
const results = document.getElementById("results");

btn.onclick = async () => {
    btn.disabled = true;
    status.innerHTML = "Analisando...";

    results.innerHTML = "";

    for (let coin of coins) {
        try {
            const r = await fetch(`/predict/${coin}`);
            const data = await r.json();

            if (data.error) {
                results.innerHTML += `<div class="card"><h3>${coin}</h3><p class="red">${data.error}</p></div>`;
                continue;
            }

            renderCoinBlock(data);
            renderChart(data);

        } catch (error) {
            results.innerHTML += `<div class="card"><h3>${coin}</h3><p class="red">Erro de conexão.</p></div>`;
        }
    }

    status.innerHTML = "Concluído.";
    btn.disabled = false;
};

function renderCoinBlock(data) {
    const dirColor = data.prediction_direction === "ALTA" ? "green" : "red";
    const arrow = data.prediction_direction === "ALTA" ? "▲" : "▼";

    const idChart = data.symbol.replace("/", "_");

    results.innerHTML += `
        <div class="card">
            <h2>${data.symbol}</h2>
            <p><strong>Atual:</strong> $${data.current_price}</p>
            <p class="${dirColor}">
                <strong>Previsto (1d):</strong> $${data.predicted_price_1} ${arrow}
            </p>
            <p><strong>Confiança:</strong> ${data.prediction_confidence}%</p>

            <div class="chart-container">
                <canvas id="chart_${idChart}"></canvas>
            </div>
        </div>
    `;
}

function renderChart(data) {
    const idChart = data.symbol.replace("/", "_");
    const ctx = document.getElementById(`chart_${idChart}`);

    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Atual', '1 dia', '7 dias', '30 dias'],
            datasets: [{
                label: 'Previsão Multi-Horizonte',
                data: [
                    data.current_price,
                    data.horizons["1"],
                    data.horizons["7"],
                    data.horizons["30"]
                ],
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}
</script>

</body>
</html>
